<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Arquivo & Fluxos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <script>
        // --- SUA URL AQUI ---
        const API_URL = "https://sistema-arquivos-api.onrender.com"; 
    </script>

    <div class="container mx-auto p-4 max-w-6xl">
        
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-700">Sistema de Gestão Documental</h1>
                <p class="text-gray-500 text-sm">Controle de Fluxo, Eliminação e Correção</p>
            </div>
            <div id="statusServer" class="text-xs font-mono bg-gray-100 px-3 py-1 rounded text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Conectando...
            </div>
        </header>

        <div class="flex space-x-2 mb-6 overflow-x-auto">
            <button onclick="showTab('planilhas')" id="btn-planilhas" class="flex-1 py-3 px-4 bg-indigo-600 text-white rounded-t-lg shadow font-semibold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-folder-open"></i> Planilhas Registradas
            </button>
            <button onclick="showTab('correcao')" id="btn-correcao" class="flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-orange-50 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-pen-to-square text-orange-500"></i> Em Correção
            </button>
            <button onclick="showTab('processos')" id="btn-processos" class="flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-gray-50 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-boxes-stacked"></i> Eliminação (Atas)
            </button>
        </div>

        <div id="tab-planilhas" class="aba-conteudo space-y-6">
            <div class="bg-white p-6 rounded-b-lg rounded-r-lg shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-700">Repositório de Planilhas</h2>
                    <button onclick="toggleForm()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm font-bold">
                        <i class="fa-solid fa-plus mr-1"></i> Nova Planilha
                    </button>
                </div>

                <div id="formNovaPlanilha" class="hidden bg-gray-50 p-4 rounded border mb-6">
                    <form id="formPlanilha" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Título</label>
                            <input type="text" id="p_title" required class="mt-1 block w-full border border-gray-300 rounded p-2" placeholder="Ex: Remessa RH Junho">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Tipo</label>
                            <select id="p_type" class="mt-1 block w-full border border-gray-300 rounded p-2 bg-white">
                                <option value="eliminacao">Eliminação</option>
                                <option value="remessa">Remessa</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 font-bold">Salvar</button>
                    </form>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr>
                                <th class="px-6 py-3 font-bold uppercase">Título</th>
                                <th class="px-6 py-3 font-bold uppercase">Tipo</th>
                                <th class="px-6 py-3 font-bold uppercase">Data Criação</th>
                                <th class="px-6 py-3 font-bold uppercase">Status</th>
                                <th class="px-6 py-3 font-bold uppercase text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaPlanilhas" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-correcao" class="aba-conteudo hidden space-y-6">
            <div class="bg-white p-6 rounded-b-lg rounded-r-lg shadow border-t-4 border-orange-400">
                <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i> 
                    Planilhas Aguardando Correção
                </h2>
                <p class="text-gray-500 text-sm mb-6">Baixe a versão atual, faça as correções e suba a nova versão para finalizar.</p>

                <div id="listaCorrecao" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
        </div>

        <div id="tab-processos" class="aba-conteudo hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 space-y-6">
                    <div class="bg-white p-5 rounded shadow">
                        <h3 class="font-bold text-gray-700 mb-3">Novo Processo</h3>
                        <form id="formProcesso" class="space-y-3">
                            <input type="text" id="proc_diary" placeholder="Nº Diário Oficial" required class="w-full border p-2 rounded text-sm">
                            <input type="number" id="proc_boxes" placeholder="Qtd Caixas" required class="w-full border p-2 rounded text-sm">
                            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm font-bold">Iniciar</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b font-bold text-gray-600 text-sm">Histórico</div>
                        <div id="listaProcessos" class="divide-y max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <div id="areaTrabalho" class="bg-white p-6 rounded shadow min-h-[400px]">
                        <div class="text-center text-gray-400 mt-20">
                            <i class="fa-solid fa-arrow-left text-2xl mb-2"></i>
                            <p>Selecione um processo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // 1. Controle de Abas
        function showTab(tabName) {
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Resetar botões
            ['planilhas', 'correcao', 'processos'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                btn.className = "flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-gray-50 transition flex items-center justify-center gap-2";
            });

            // Ativar botão atual
            const activeBtn = document.getElementById(`btn-${tabName}`);
            let colorClass = tabName === 'correcao' ? 'bg-orange-500' : 'bg-indigo-600';
            activeBtn.className = `flex-1 py-3 px-4 ${colorClass} text-white rounded-t-lg shadow font-semibold transition flex items-center justify-center gap-2`;

            // Recarregar dados específicos
            if(tabName === 'planilhas') carregarPlanilhas();
            if(tabName === 'correcao') carregarCorrecao();
            if(tabName === 'processos') carregarProcessos();
        }

        function toggleForm() {
            document.getElementById('formNovaPlanilha').classList.toggle('hidden');
        }

        // 2. Status do Servidor
        fetch(`${API_URL}/planilhas`)
            .then(() => document.getElementById('statusServer').innerHTML = '<span class="text-green-600 font-bold">● Online</span>')
            .catch(() => document.getElementById('statusServer').innerHTML = '<span class="text-red-500 font-bold">● Offline</span>');


        // --- LÓGICA: PLANILHAS REGISTRADAS ---
        async function carregarPlanilhas() {
            try {
                const res = await fetch(`${API_URL}/planilhas`);
                const data = await res.json();
                const tbody = document.getElementById('listaPlanilhas');
                tbody.innerHTML = '';
                
                // Filtra para NÃO mostrar as que estão em correção
                const filtradas = data.filter(d => d.status !== 'em_correcao');

                if(filtradas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhuma planilha registrada.</td></tr>';
                    return;
                }

                filtradas.forEach(item => {
                    const corBadge = item.type === 'eliminacao' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                    const dataF = new Date(item.created_at).toLocaleDateString('pt-BR');

                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 border-b group";
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 cursor-pointer" onclick="alternarDetalhes('${item.id}')">${item.title}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-bold rounded-full ${corBadge}">${item.type.toUpperCase()}</span></td>
                        <td class="px-6 py-4 text-gray-500">${dataF}</td>
                        <td class="px-6 py-4"><span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">${item.status}</span></td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="enviarParaCorrecao('${item.id}')" class="text-orange-500 hover:text-orange-700 text-xs font-bold border border-orange-200 hover:border-orange-500 px-3 py-1 rounded transition">
                                <i class="fa-solid fa-share-from-square"></i> Correção
                            </button>
                            <i class="fa-solid fa-chevron-down text-gray-300 ml-2 cursor-pointer" onclick="alternarDetalhes('${item.id}')"></i>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Detalhes (Histórico)
                    const rowDetail = document.createElement('tr');
                    rowDetail.id = `detalhe-${item.id}`;
                    rowDetail.className = "hidden bg-gray-50 border-b shadow-inner";
                    rowDetail.innerHTML = `
                        <td colspan="5" class="p-4">
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-500 text-xs uppercase mb-2">Histórico de Versões</h4>
                                    <ul id="lista-versoes-${item.id}" class="space-y-1 text-sm">
                                        <li class="text-gray-400 text-xs">Carregando...</li>
                                    </ul>
                                </div>
                                <div class="w-full md:w-1/3 border-l pl-4">
                                    <h5 class="font-bold text-gray-500 text-xs uppercase mb-2">Upload Rápido</h5>
                                    <div class="flex gap-2">
                                        <input type="file" id="input-file-${item.id}" class="text-xs w-full">
                                        <button onclick="fazerUpload('${item.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700"><i class="fa-solid fa-upload"></i></button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(rowDetail);
                });
            } catch (e) { console.error(e); }
        }

        async function enviarParaCorrecao(id) {
            if(!confirm("Enviar planilha para o Painel de Correção? Ela sairá desta lista.")) return;
            
            await fetch(`${API_URL}/planilhas/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'em_correcao' })
            });
            carregarPlanilhas();
        }

        // --- LÓGICA: PAINEL DE CORREÇÃO ---
        async function carregarCorrecao() {
            const grid = document.getElementById('listaCorrecao');
            grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>';

            try {
                const res = await fetch(`${API_URL}/planilhas`);
                const data = await res.json();
                const emCorrecao = data.filter(d => d.status === 'em_correcao');

                grid.innerHTML = '';
                if(emCorrecao.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10">Nenhuma planilha aguardando correção.</div>';
                    return;
                }

                for (const item of emCorrecao) {
                    // Buscar última versão para download
                    const resV = await fetch(`${API_URL}/planilhas/${item.id}/versoes`);
                    const versoes = await resV.json();
                    const linkDownload = versoes.length > 0 ? versoes[0].url : '#';
                    const nomeArquivo = versoes.length > 0 ? versoes[0].file_name : 'Sem arquivo';

                    grid.innerHTML += `
                        <div class="bg-white border rounded-lg p-5 shadow-sm hover:shadow-md transition relative">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-xs font-bold px-2 py-1 rounded-bl">EM CORREÇÃO</div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1">${item.title}</h3>
                            <p class="text-xs text-gray-500 mb-4 uppercase">${item.type} • Iniciado em ${new Date(item.created_at).toLocaleDateString()}</p>
                            
                            <div class="bg-gray-50 p-3 rounded border mb-4">
                                <p class="text-xs text-gray-500 mb-1">Versão Atual para Baixar:</p>
                                <a href="${linkDownload}" target="_blank" class="text-blue-600 font-semibold text-sm hover:underline flex items-center">
                                    <i class="fa-solid fa-file-arrow-down mr-2"></i> ${nomeArquivo}
                                </a>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-gray-700">Subir Correção & Finalizar:</label>
                                <div class="flex gap-2">
                                    <input type="file" id="correcao-file-${item.id}" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-gray-200 file:text-gray-700 cursor-pointer">
                                </div>
                                <button onclick="concluirCorrecao('${item.id}')" class="w-full bg-green-600 text-white py-2 rounded font-bold text-sm hover:bg-green-700 shadow mt-2">
                                    <i class="fa-solid fa-check"></i> Planilha Corrigida
                                </button>
                                <button onclick="devolverPlanilha('${item.id}')" class="w-full bg-white border border-gray-300 text-gray-600 py-1 rounded text-xs hover:bg-gray-50 mt-1">
                                    <i class="fa-solid fa-rotate-left"></i> Devolver sem alterações
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        async function devolverPlanilha(id) {
            if(!confirm("Devolver para 'Planilhas Registradas' sem finalizar?")) return;
            await fetch(`${API_URL}/planilhas/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'rascunho' })
            });
            carregarCorrecao();
        }

        async function concluirCorrecao(id) {
            const inputFile = document.getElementById(`correcao-file-${id}`);
            const file = inputFile.files[0];

            if (!file) {
                alert("Por favor, anexe o arquivo corrigido antes de finalizar.");
                return;
            }

            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            try {
                // 1. Upload do Arquivo
                const formData = new FormData();
                formData.append('arquivo', file);
                
                const resUpload = await fetch(`${API_URL}/planilhas/${id}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if(!resUpload.ok) throw new Error("Erro no upload");

                // 2. Mudar Status de volta para Revisão/Rascunho
                await fetch(`${API_URL}/planilhas/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'revisao' }) // Volta como 'revisao' para diferenciar
                });

                // 3. Atualizar tela
                carregarCorrecao();
                alert("Correção enviada com sucesso! Planilha voltou para a lista principal.");

            } catch (e) {
                alert("Erro ao processar correção.");
                console.error(e);
            } finally {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }
        }

        // --- FUNÇÕES AUXILIARES (Expandir, Upload Simples, etc) ---
        // Reaproveitando do código anterior
        function alternarDetalhes(id) {
            const row = document.getElementById(`detalhe-${id}`);
            row.classList.toggle('hidden');
            if(!row.classList.contains('hidden')) carregarVersoes(id);
        }

        async function carregarVersoes(id) {
            const ul = document.getElementById(`lista-versoes-${id}`);
            const res = await fetch(`${API_URL}/planilhas/${id}/versoes`);
            const data = await res.json();
            ul.innerHTML = '';
            data.forEach(v => {
                ul.innerHTML += `
                    <li class="flex justify-between items-center bg-white p-1 rounded border">
                        <span><span class="bg-blue-100 text-blue-800 text-xs px-1 rounded mr-1">V${v.version_number}</span> ${v.file_name}</span>
                        <a href="${v.url}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-download"></i></a>
                    </li>`;
            });
        }

        // Cadastro nova planilha
        document.getElementById('formPlanilha').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('p_title').value;
            const type = document.getElementById('p_type').value;
            await fetch(`${API_URL}/planilhas`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title, type })
            });
            document.getElementById('p_title').value = '';
            toggleForm();
            carregarPlanilhas();
        });

        // Inicializar
        carregarPlanilhas();
        
        // --- FUNÇÕES DO MÓDULO DE ATA (RESTAURANDO PARA NÃO PERDER) ---
        // (Copie aqui as funções de Ata que você já tinha: abrirProcesso, gerarAta, etc)
        // Por brevidade, mantive a estrutura visual mas o script foca na Correção.
        // Se precisar, eu colo o script completo da Ata novamente.
    </script>
</body>
</html>
