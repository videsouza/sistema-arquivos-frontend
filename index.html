<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Arquivo Central</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col">

    <script>
        // --- SEU LINK DO RENDER AQUI (SEM A BARRA NO FINAL) ---
        const API_URL = "https://sistema-arquivos-api.onrender.com"; 
    </script>

    <div class="container mx-auto p-4 max-w-6xl flex-1 flex flex-col">
        
        <header class="mb-6 bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-700">Sistema de Gestão Documental</h1>
                <p class="text-gray-500 text-sm">Controle de Fluxo, Correção e Eliminação</p>
            </div>
            <div id="statusServer" class="text-xs font-mono bg-gray-100 px-3 py-1 rounded text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Conectando...
            </div>
        </header>

        <div class="flex space-x-2 mb-4 overflow-x-auto">
            <button onclick="showTab('planilhas')" id="btn-planilhas" class="flex-1 py-3 px-4 bg-indigo-600 text-white rounded-t-lg shadow font-semibold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-folder-open"></i> Planilhas Registradas
            </button>
            <button onclick="showTab('correcao')" id="btn-correcao" class="flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-orange-50 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-pen-to-square text-orange-500"></i> Em Correção
            </button>
            <button onclick="showTab('processos')" id="btn-processos" class="flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-gray-50 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-boxes-stacked"></i> Eliminação (Atas)
            </button>
        </div>

        <div class="flex-1 bg-white rounded-b-lg rounded-r-lg shadow p-6 min-h-[500px]">

            <div id="tab-planilhas" class="aba-conteudo space-y-6">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="text-lg font-bold text-gray-700">Repositório de Planilhas</h2>
                    <button onclick="toggleForm()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm font-bold shadow transition">
                        <i class="fa-solid fa-plus mr-1"></i> Nova Planilha
                    </button>
                </div>

                <div id="formNovaPlanilha" class="hidden bg-gray-50 p-4 rounded border mb-6 border-green-200">
                    <form id="formPlanilha" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Título / Identificação</label>
                            <input type="text" id="p_title" required class="block w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Ex: Remessa RH Junho/2025">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                            <select id="p_type" class="block w-full border border-gray-300 rounded p-2 bg-white focus:ring-2 focus:ring-green-500 outline-none">
                                <option value="eliminacao">Eliminação</option>
                                <option value="remessa">Remessa</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 font-bold shadow">Salvar Planilha</button>
                    </form>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr>
                                <th class="px-6 py-3 font-bold uppercase">Título</th>
                                <th class="px-6 py-3 font-bold uppercase">Tipo</th>
                                <th class="px-6 py-3 font-bold uppercase">Data</th>
                                <th class="px-6 py-3 font-bold uppercase">Status</th>
                                <th class="px-6 py-3 font-bold uppercase text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaPlanilhas" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-correcao" class="aba-conteudo hidden space-y-6">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-orange-200">
                    <div class="bg-orange-100 p-2 rounded-full text-orange-600"><i class="fa-solid fa-triangle-exclamation text-xl"></i></div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-700">Planilhas em Correção</h2>
                        <p class="text-xs text-gray-500">Baixe a versão atual, corrija e faça o upload para finalizar.</p>
                    </div>
                </div>

                <div id="listaCorrecao" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="tab-processos" class="aba-conteudo hidden h-full">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                    <div class="md:col-span-1 space-y-6 flex flex-col h-full">
                        <div class="bg-blue-50 p-4 rounded border border-blue-100">
                            <h3 class="font-bold text-blue-800 mb-2 text-sm uppercase">Novo Processo</h3>
                            <form id="formProcesso" class="space-y-3">
                                <input type="text" id="proc_diary" placeholder="Nº Diário Oficial" required class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-400 outline-none">
                                <input type="number" id="proc_boxes" placeholder="Total Caixas" required class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-400 outline-none">
                                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm font-bold shadow">Iniciar</button>
                            </form>
                        </div>
                        
                        <div class="flex-1 bg-white rounded border overflow-hidden flex flex-col">
                            <div class="p-3 bg-gray-100 border-b font-bold text-gray-600 text-xs uppercase">Histórico de Processos</div>
                            <div id="listaProcessos" class="divide-y overflow-y-auto flex-1 max-h-[400px]">
                                </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 flex flex-col h-full">
                        <div id="areaTrabalho" class="bg-gray-50 p-6 rounded border border-dashed border-gray-300 flex-1 relative">
                            <div class="text-center text-gray-400 mt-20">
                                <i class="fa-solid fa-arrow-left text-3xl mb-4 text-gray-300"></i>
                                <p class="font-medium">Selecione um processo ao lado para começar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. NAVEGAÇÃO E UTILITÁRIOS
        // ---------------------------------------------------------

        function showTab(tabName) {
            // Esconde todas
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.add('hidden'));
            // Mostra a escolhida
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Reseta botões
            ['planilhas', 'correcao', 'processos'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                btn.className = "flex-1 py-3 px-4 bg-white text-gray-600 rounded-t-lg shadow font-semibold hover:bg-gray-50 transition flex items-center justify-center gap-2";
            });

            // Ativa botão
            const activeBtn = document.getElementById(`btn-${tabName}`);
            let colorClass = tabName === 'correcao' ? 'bg-orange-500' : 'bg-indigo-600';
            activeBtn.className = `flex-1 py-3 px-4 ${colorClass} text-white rounded-t-lg shadow font-semibold transition flex items-center justify-center gap-2`;

            // Carrega dados
            if(tabName === 'planilhas') carregarPlanilhas();
            if(tabName === 'correcao') carregarCorrecao();
            if(tabName === 'processos' && document.getElementById('listaProcessos').innerHTML === '') carregarProcessos();
        }

        function toggleForm() {
            document.getElementById('formNovaPlanilha').classList.toggle('hidden');
        }

        // Verifica conexão ao abrir
        fetch(`${API_URL}/planilhas`)
            .then(() => document.getElementById('statusServer').innerHTML = '<span class="text-green-600 font-bold">● Sistema Online</span>')
            .catch(() => document.getElementById('statusServer').innerHTML = '<span class="text-red-500 font-bold">● Sem Conexão</span>');


        // ---------------------------------------------------------
        // 2. ABA: PLANILHAS REGISTRADAS
        // ---------------------------------------------------------

        async function carregarPlanilhas() {
            try {
                const res = await fetch(`${API_URL}/planilhas`);
                const data = await res.json();
                const tbody = document.getElementById('listaPlanilhas');
                tbody.innerHTML = '';
                
                // Filtra: Esconde as que estão em correção
                const filtradas = data.filter(d => d.status !== 'em_correcao');

                if(filtradas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhuma planilha registrada.</td></tr>';
                    return;
                }

                filtradas.forEach(item => {
                    const corBadge = item.type === 'eliminacao' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                    const dataF = new Date(item.created_at).toLocaleDateString('pt-BR');

                    // Linha Principal
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 border-b group transition";
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 cursor-pointer" onclick="alternarDetalhes('${item.id}')">
                            <i class="fa-regular fa-file-lines text-gray-400 mr-2"></i>${item.title}
                        </td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-bold rounded-full ${corBadge}">${item.type.toUpperCase()}</span></td>
                        <td class="px-6 py-4 text-gray-500 text-xs">${dataF}</td>
                        <td class="px-6 py-4"><span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600 uppercase">${item.status}</span></td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick="enviarParaCorrecao('${item.id}')" class="text-orange-500 hover:text-white hover:bg-orange-500 border border-orange-200 px-2 py-1 rounded text-xs font-bold transition" title="Enviar para Correção">
                                <i class="fa-solid fa-share-from-square"></i> Correção
                            </button>
                            <button onclick="alternarDetalhes('${item.id}')" class="text-gray-400 hover:text-blue-600 px-2">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Detalhes (Histórico + Upload)
                    const rowDetail = document.createElement('tr');
                    rowDetail.id = `detalhe-${item.id}`;
                    rowDetail.className = "hidden bg-gray-50 border-b shadow-inner";
                    rowDetail.innerHTML = `
                        <td colspan="5" class="p-4">
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-500 text-xs uppercase mb-2"><i class="fa-solid fa-clock-rotate-left"></i> Histórico de Versões</h4>
                                    <ul id="lista-versoes-${item.id}" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                                        <li class="text-gray-400 text-xs italic">Carregando versões...</li>
                                    </ul>
                                </div>
                                <div class="w-full md:w-1/3 border-l pl-4 border-gray-200">
                                    <h5 class="font-bold text-gray-500 text-xs uppercase mb-2">Upload Rápido (Nova Versão)</h5>
                                    <div class="flex flex-col gap-2">
                                        <input type="file" id="input-file-${item.id}" class="text-xs w-full text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                        <button onclick="fazerUpload('${item.id}')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-blue-700 transition shadow-sm w-full">
                                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Enviar Versão
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(rowDetail);
                });
            } catch (e) { console.error(e); }
        }

        // Criar Planilha
        document.getElementById('formPlanilha').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('p_title').value;
            const type = document.getElementById('p_type').value;
            const btn = e.submitter;
            const txt = btn.innerText;
            btn.innerText = 'Salvando...'; btn.disabled = true;

            try {
                await fetch(`${API_URL}/planilhas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title, type })
                });
                document.getElementById('p_title').value = '';
                toggleForm();
                carregarPlanilhas();
            } catch(err) { alert('Erro ao salvar'); }
            finally { btn.innerText = txt; btn.disabled = false; }
        });

        // Enviar p/ Correção
        async function enviarParaCorrecao(id) {
            if(!confirm("Mover esta planilha para a aba 'Em Correção'?")) return;
            await fetch(`${API_URL}/planilhas/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'em_correcao' })
            });
            carregarPlanilhas();
        }

        // --- FUNÇÕES COMUNS DE UPLOAD/VERSÕES ---

        function alternarDetalhes(id) {
            const row = document.getElementById(`detalhe-${id}`);
            row.classList.toggle('hidden');
            if(!row.classList.contains('hidden')) carregarVersoes(id);
        }

        async function carregarVersoes(id) {
            const ul = document.getElementById(`lista-versoes-${id}`);
            if(!ul) return; // Proteção caso esteja na outra aba
            ul.innerHTML = '<li class="text-gray-400 text-xs">Atualizando...</li>';
            
            try {
                const res = await fetch(`${API_URL}/planilhas/${id}/versoes`);
                const data = await res.json();
                ul.innerHTML = '';
                
                if(data.length === 0) {
                    ul.innerHTML = '<li class="text-gray-400 text-xs italic">Nenhum arquivo.</li>';
                    return;
                }

                data.forEach(v => {
                    ul.innerHTML += `
                        <li class="flex justify-between items-center bg-white p-2 rounded border border-gray-100 hover:bg-gray-50">
                            <div class="flex items-center overflow-hidden">
                                <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-1.5 py-0.5 rounded mr-2 shrink-0">V${v.version_number}</span>
                                <span class="text-gray-600 truncate text-xs" title="${v.file_name}">${v.file_name}</span>
                            </div>
                            <a href="${v.url}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-2" title="Baixar">
                                <i class="fa-solid fa-download"></i>
                            </a>
                        </li>`;
                });
            } catch(e) { ul.innerHTML = '<li class="text-red-400 text-xs">Erro.</li>'; }
        }

        async function fazerUpload(id) {
            const input = document.getElementById(`input-file-${id}`);
            const file = input.files[0];
            if (!file) return alert("Selecione um arquivo!");

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;

            const formData = new FormData();
            formData.append('arquivo', file);

            try {
                const res = await fetch(`${API_URL}/planilhas/${id}/upload`, { method: 'POST', body: formData });
                if (res.ok) {
                    input.value = '';
                    carregarVersoes(id);
                    alert("Sucesso! Nova versão enviada.");
                } else {
                    alert("Erro no upload.");
                }
            } catch (e) { alert("Erro de conexão."); }
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        }


        // ---------------------------------------------------------
        // 3. ABA: EM CORREÇÃO
        // ---------------------------------------------------------

        async function carregarCorrecao() {
            const grid = document.getElementById('listaCorrecao');
            grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><br>Buscando...</div>';

            try {
                const res = await fetch(`${API_URL}/planilhas`);
                const data = await res.json();
                const emCorrecao = data.filter(d => d.status === 'em_correcao');

                grid.innerHTML = '';
                if(emCorrecao.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10 border border-dashed rounded bg-gray-50">Nenhuma planilha aguardando correção.</div>';
                    return;
                }

                for (const item of emCorrecao) {
                    // Busca versões para pegar o link da última
                    const resV = await fetch(`${API_URL}/planilhas/${item.id}/versoes`);
                    const versoes = await resV.json();
                    const linkDownload = versoes.length > 0 ? versoes[0].url : '#';
                    const nomeArquivo = versoes.length > 0 ? versoes[0].file_name : 'Nenhum arquivo';
                    const classeLink = versoes.length > 0 ? 'text-blue-600 hover:underline' : 'text-gray-400 pointer-events-none';

                    grid.innerHTML += `
                        <div class="bg-white border border-orange-200 rounded-lg p-5 shadow-sm hover:shadow-md transition relative flex flex-col">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-1 rounded-bl uppercase tracking-wide">Aguardando</div>
                            
                            <h3 class="font-bold text-gray-800 text-lg mb-1 truncate" title="${item.title}">${item.title}</h3>
                            <p class="text-xs text-gray-500 mb-4 uppercase">${item.type} • ${new Date(item.created_at).toLocaleDateString()}</p>
                            
                            <div class="bg-gray-50 p-3 rounded border border-gray-100 mb-4">
                                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Versão Atual (Para revisão)</p>
                                <a href="${linkDownload}" target="_blank" class="${classeLink} font-semibold text-sm flex items-center truncate">
                                    <i class="fa-solid fa-file-arrow-down mr-2"></i> ${nomeArquivo}
                                </a>
                            </div>

                            <div class="mt-auto pt-3 border-t border-gray-100 space-y-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1">Anexar Versão Corrigida:</label>
                                    <input type="file" id="correcao-file-${item.id}" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-green-50 file:text-green-700 cursor-pointer border rounded p-1">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="concluirCorrecao('${item.id}')" class="w-full bg-green-600 text-white py-2 rounded font-bold text-sm hover:bg-green-700 shadow transition flex justify-center items-center gap-2">
                                        <i class="fa-solid fa-check"></i> Enviar & Finalizar
                                    </button>
                                    <button onclick="devolverPlanilha('${item.id}')" class="w-full bg-white border border-gray-300 text-gray-500 py-1 rounded text-xs hover:bg-gray-50 transition">
                                        <i class="fa-solid fa-rotate-left"></i> Devolver (Sem upload)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        async function devolverPlanilha(id) {
            if(!confirm("Devolver para a lista principal sem marcar como corrigida?")) return;
            await fetch(`${API_URL}/planilhas/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'revisao' })
            });
            carregarCorrecao();
        }

        async function concluirCorrecao(id) {
            const inputFile = document.getElementById(`correcao-file-${id}`);
            const file = inputFile.files[0];

            if (!file) return alert("⚠️ Selecione o arquivo corrigido antes de finalizar.");

            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...'; btn.disabled = true;

            try {
                // 1. Upload
                const formData = new FormData();
                formData.append('arquivo', file);
                const resUpload = await fetch(`${API_URL}/planilhas/${id}/upload`, { method: 'POST', body: formData });
                if(!resUpload.ok) throw new Error("Erro upload");

                // 2. Status 'revisao' (volta pra lista principal)
                await fetch(`${API_URL}/planilhas/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'revisao' }) 
                });

                alert("✅ Planilha corrigida e devolvida com sucesso!");
                carregarCorrecao();

            } catch (e) { alert("Erro ao processar."); }
            finally { btn.innerHTML = originalHTML; btn.disabled = false; }
        }


        // ---------------------------------------------------------
        // 4. ABA: ELIMINAÇÃO (PROCESSOS)
        // ---------------------------------------------------------

        async function carregarProcessos() {
            try {
                const res = await fetch(`${API_URL}/processos`);
                const data = await res.json();
                const lista = document.getElementById('listaProcessos');
                lista.innerHTML = ''; 

                data.forEach(proc => {
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-blue-50 cursor-pointer border-l-4 border-transparent hover:border-blue-500 transition border-b";
                    div.onclick = () => abrirProcesso(proc.diary_number, proc.total_boxes, proc.id);
                    div.innerHTML = `
                        <div class="font-bold text-gray-700 text-sm mb-1"><i class="fa-solid fa-book-open mr-1 text-gray-400"></i> Diário ${proc.diary_number}</div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>${proc.total_boxes} caixas</span>
                            <span>${new Date(proc.created_at).toLocaleDateString()}</span>
                        </div>
                    `;
                    lista.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('formProcesso').addEventListener('submit', async (e) => {
            e.preventDefault();
            const diary = document.getElementById('proc_diary').value;
            const boxes = document.getElementById('proc_boxes').value;
            
            await fetch(`${API_URL}/processos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ diary_number: diary, total_boxes: boxes })
            });
            
            document.getElementById('proc_diary').value = '';
            document.getElementById('proc_boxes').value = '';
            carregarProcessos();
        });

        function abrirProcesso(diary, totalBoxes, id) {
            const area = document.getElementById('areaTrabalho');
            
            let checkboxesHTML = '';
            for(let i=1; i<=totalBoxes; i++) {
                checkboxesHTML += `
                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-blue-50 bg-white shadow-sm transition">
                        <input type="checkbox" value="${i}" class="box-check form-checkbox h-4 w-4 text-blue-600 mr-2 rounded">
                        <span class="text-gray-700 font-mono text-xs font-bold">${i}</span>
                    </label>
                `;
            }

            area.innerHTML = `
                <div class="mb-4 border-b pb-4 bg-white sticky top-0 z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Processo: Diário ${diary}</h2>
                            <p class="text-xs text-gray-500">Selecione as caixas eliminadas HOJE e preencha os dados.</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded border border-blue-100 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs mb-4">
                        <div>
                            <label class="block font-bold text-gray-600 mb-1">Funcionário Responsável</label>
                            <input type="text" id="ata_funcionario" value="Vinicius Augusto de Souza" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                        <div>
                            <label class="block font-bold text-gray-600 mb-1">Nº Planilha Eliminação</label>
                            <input type="text" id="ata_planilha" value="01/SEC/2025" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                        <div>
                            <label class="block font-bold text-gray-600 mb-1">Data do Diário</label>
                            <input type="text" id="ata_data_diario" value="04/06/2025" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                        <div>
                            <label class="block font-bold text-gray-600 mb-1">Páginas</label>
                            <input type="text" id="ata_paginas" value="07 a 16" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                    </div>

                    <button onclick="gerarAta('${id}', '${diary}')" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700 text-sm font-bold transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-word"></i> Gerar Ata do Dia (.docx)
                    </button>
                </div>

                <div class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-2 overflow-y-auto p-1 h-[300px] border rounded bg-gray-50">
                    ${checkboxesHTML}
                </div>
            `;
        }

        async function gerarAta(id, diary) {
            const checked = Array.from(document.querySelectorAll('.box-check:checked')).map(cb => cb.value);
            
            if(checked.length === 0) return alert("⚠️ Selecione as caixas eliminadas hoje.");

            const funcionario = document.getElementById('ata_funcionario').value;
            const planilha = document.getElementById('ata_planilha').value;
            const dataDiario = document.getElementById('ata_data_diario').value;
            const paginas = document.getElementById('ata_paginas').value;
            
            const btn = document.querySelector('button[onclick^="gerarAta"]');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...'; btn.disabled = true;
            
            try {
                // Log no banco
                await fetch(`${API_URL}/processos/${id}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ boxes_eliminated: checked.join(', ') })
                });

                // Gerar Word
                const res = await fetch(`${API_URL}/processos/${id}/ata-word`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        boxes_eliminated: checked.join(', '),
                        diary_number: diary,
                        funcionario, planilha, data_diario: dataDiario, paginas
                    })
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Ata_${diary.replace(/\//g, '-')}_${new Date().toISOString().split('T')[0]}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else { alert("Erro ao gerar arquivo."); }

            } catch (error) { alert("Erro de conexão."); } 
            finally { btn.innerHTML = textoOriginal; btn.disabled = false; }
        }

        // INICIALIZAÇÃO
        carregarPlanilhas();

    </script>
</body>
</html>
